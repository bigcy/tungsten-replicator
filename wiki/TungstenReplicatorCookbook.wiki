#summary Tungsten Replicator cookbook
#labels Featured,Phase-Deploy
<wiki:toc max_depth="4" />

= Tungsten Replicator Cookbook =
 
This is a collection of practical recipes to deal with Tungsten Replicator.

  * [TRCBasicInstallation Basic installation]
    * [http://code.google.com/p/tungsten-replicator/wiki/TRCBasicInstallation?ts=1317307167&updated=TRCBasicInstallation#Install_a_master_/_slave_cluster Install a master / slave cluster]
    * [http://code.google.com/p/tungsten-replicator/wiki/TRCBasicInstallation?ts=1317307317&updated=TRCBasicInstallation#Get_the_replicator Get the replicator]
    * [http://code.google.com/p/tungsten-replicator/wiki/TRCBasicInstallation?ts=1317307317&updated=TRCBasicInstallation#Install_a_master_slave_directory_with_customized_parameters Install a master slave directory with customized parameters]
    * [http://code.google.com/p/tungsten-replicator/wiki/TRCBasicInstallation?ts=1317307317&updated=TRCBasicInstallation#Install_more_than_one_Tungsten_Replicator_in_one_host Install more than one Tungsten Replicator in one host]
    * [http://code.google.com/p/tungsten-replicator/wiki/TRCBasicInstallation?ts=1317307317&updated=TRCBasicInstallation#Install_a_direct_slave_with_parallel_replication Install a direct slave with parallel replication]
    * [http://code.google.com/p/tungsten-replicator/wiki/TRCBasicInstallation?ts=1317307317&updated=TRCBasicInstallation#Taking_over_replication_from_a_MySQL_slave_in_direct_mode Taking over replication from a MySQL slave in direct mode]
    * [http://code.google.com/p/tungsten-replicator/wiki/TRCBasicInstallation?ts=1317307317&updated=TRCBasicInstallation#Install_Tungsten_master/slave_replication_in_a_sandbox Install Tungsten master/slave replication in a sandbox]
    * [http://code.google.com/p/tungsten-replicator/wiki/TRCBasicInstallation?ts=1317307317&updated=TRCBasicInstallation#Chain_two_replication_clusters Chain two replication clusters]
    * [http://code.google.com/p/tungsten-replicator/wiki/TRCBasicInstallation?ts=1317307317&updated=TRCBasicInstallation#Modify_one_or_more_properties_with_the_installer Modify one or more properties with the installer]
    * [http://code.google.com/p/tungsten-replicator/wiki/TRCBasicInstallation?ts=1317307317&updated=TRCBasicInstallation#Add_one_slave_to_an_existing_master Add one slave to an existing master]
    * [http://code.google.com/p/tungsten-replicator/wiki/TRCBasicInstallation?ts=1317307317&updated=TRCBasicInstallation#Start_a_master_service_with_a_given_binlog_and_position Start a master service with a given binlog and position]
    * [http://code.google.com/p/tungsten-replicator/wiki/TRCBasicInstallation?ts=1317307317&updated=TRCBasicInstallation#Modify_the_configuration_template_file_prior_to_configuration Modify the configuration template file prior to configuration]

  * [http://code.google.com/p/tungsten-replicator/wiki/TRCMultiMasterInstallation?ts=1317308314&updated=TRCMultiMasterInstallation#Multi-Master_Installation Multi-Master Installation]
    * [http://code.google.com/p/tungsten-replicator/wiki/TRCMultiMasterInstallation?ts=1317308314&updated=TRCMultiMasterInstallation#Install_bi-directional_replication Install bi-directional replication]
    * [http://code.google.com/p/tungsten-replicator/wiki/TRCMultiMasterInstallation?ts=1317308314&updated=TRCMultiMasterInstallation#Install_bi-directional_replication_with_an_additional_slave Install bi-directional replication with an additional slave]
    * [http://code.google.com/p/tungsten-replicator/wiki/TRCMultiMasterInstallation?ts=1317308314&updated=TRCMultiMasterInstallation#Install_a_three_masters_replication Install a three masters replication]
    * [http://code.google.com/p/tungsten-replicator/wiki/TRCMultiMasterInstallation?ts=1317308314&updated=TRCMultiMasterInstallation#Install_a_four_masters_replication Install a four masters replication]

  * [http://code.google.com/p/tungsten-replicator/wiki/TRCHeterogeneousReplication?ts=1317309327&updated=TRCHeterogeneousReplication#Heterogeneous_Replication Heterogeneous Replication]  
    * [http://code.google.com/p/tungsten-replicator/wiki/TRCHeterogeneousReplication?ts=1317309327&updated=TRCHeterogeneousReplication#PostgreSQL_to_PostgreSQL_and_MySQL_Replication PostgreSQL to PostgreSQL and MySQL Replication]
        * [http://code.google.com/p/tungsten-replicator/wiki/TRCHeterogeneousReplication?ts=1317309327&updated=TRCHeterogeneousReplication#Install_a_prototype_PostgreSQL_logical_replicator_(master) Install a prototype PostgreSQL logical replicator (master)]
        * [http://code.google.com/p/tungsten-replicator/wiki/TRCHeterogeneousReplication?ts=1317309327&updated=TRCHeterogeneousReplication#Install_a_PostgreSQL_applier_replicator_(slave) Install a PostgreSQL applier replicator (slave)]
        * [http://code.google.com/p/tungsten-replicator/wiki/TRCHeterogeneousReplication?ts=1317309327&updated=TRCHeterogeneousReplication#Install_a_MySQL_applier_replicator_(slave) Install a MySQL applier replicator (slave)]
    * [http://code.google.com/p/tungsten-replicator/wiki/TRCHeterogeneousReplication?ts=1317309327&updated=TRCHeterogeneousReplication#MySQL_to_PostgreSQL_and_Oracle_Replication MySQL to PostgreSQL and Oracle Replication]
        * [http://code.google.com/p/tungsten-replicator/wiki/TRCHeterogeneousReplication?ts=1317309327&updated=TRCHeterogeneousReplication#Install_a_MySQL_Master Install a MySQL Master]
        * [http://code.google.com/p/tungsten-replicator/wiki/TRCHeterogeneousReplication?ts=1317309327&updated=TRCHeterogeneousReplication#Install_a_PostgreSQL_Slave Install a PostgreSQL Slave]
        * [http://code.google.com/p/tungsten-replicator/wiki/TRCHeterogeneousReplication?ts=1317309327&updated=TRCHeterogeneousReplication#Install_an_Oracle_Slave Install an Oracle Slave]
    * [http://code.google.com/p/tungsten-replicator/wiki/TRCHeterogeneousReplication?ts=1317309327&updated=TRCHeterogeneousReplication#MySQL_to_MongoDB_Replication MySQL to MongoDB Replication]
        * [http://code.google.com/p/tungsten-replicator/wiki/TRCHeterogeneousReplication?ts=1317309327&updated=TRCHeterogeneousReplication#Install_a_MySQL_Master Install a MySQL Master]
        * [http://code.google.com/p/tungsten-replicator/wiki/TRCHeterogeneousReplication?ts=1317309327&updated=TRCHeterogeneousReplication#Install_a_MongoDB_Slave Install a MongoDB Slave] 


== Administration ==

=== Check replication services ===

The tool that helps you look inside the replicator is called {{{trepctl}}}, and it's located under $TUNGSTEN_HOME/tungsten/tungsten-replicator/bin.

To get a list of the existing services, run:

{{{
TUNGSTEN_BIN=$TUNGSTEN_HOME/tungsten/tungsten-replicator/bin

$TUNGSTEN_BIN/trepctl services
}}}


=== Check replication status ===

The 'status' option of trepctl will give you detailed information about the health of the replicator.
{{{
$TUNGSTEN_BIN/trepctl -service service_name status
}}}


=== Suspend and resume replication ===

To suspend a replicator service, put it offline:

{{{
$TUNGSTEN_BIN/trepctl -service service_name offline
}}}

Notice that this operation will not affect other services, if your replicator is running more than one.

To put it back online, you change the keyword.

{{{
$TUNGSTEN_BIN/trepctl -service service_name online
}}}

You may go online with several options, such as skipping one or more transactions, or replicating from a different file/position.

==== Resuming replication and skipping a transaction ====

{{{
$TUNGSTEN_BIN/trepctl -service service_name online -skip-seqno 2340
}}}

=== Inspect Transaction History Logs ===

The THL (Transaction History Logs) is the data that Tungsten has taken from the master's binary logs and transported to its servers, with the addition of some metadata.

There is a tool, called 'thl', which allows you to see the status of the logs and eventually list its contents. 

{{{
$TUNGSTEN_BIN/thl -service service_name info
}}}
This command will give you a summary of what you may find in the THL.

{{{
$TUNGSTEN_BIN/thl -service service_name index
}}}
Similar to the previous one, it will give you a list of the available THL files, with the minimum and maximum transaction number for each file.

{{{
$TUNGSTEN_BIN/thl -service service_name list
}}}
This command will list all the transactions that are available for the given service. This is potentially dangerous, since it may list millions of transactions on your screen. See the next ones for more options.

{{{
$TUNGSTEN_BIN/thl -service service_name list -low 0 -high 1858
$TUNGSTEN_BIN/thl -service service_name list -seqno 34902
}}}
The first command lists transactions in a given range, while the second lists only one specific transaction.

=== Check parallel replication status ===

==== Shards ====

{{{
$TUNGSTEN_BIN/trepctl -service service_name status -name shards
}}}

==== Tasks ====

{{{
$TUNGSTEN_BIN/trepctl -service service_name status -name tasks
}}}

==== Stores ====

{{{
$TUNGSTEN_BIN/trepctl -service service_name status -name stores
}}}

=== Resetting the Transaction History Logs ===

The THL can be cleared in order to reset the replication service and start from a clean slate.

 * Suspend replication
{{{
$TUNGSTEN_BIN/trepctl -service service_name offline
}}}
 * Remove all existing THL files
{{{
rm $TUNGSTEN_HOME/thl/service_name/*
}}}
 * Remove all existing relay files
{{{
rm $TUNGSTEN_HOME/relay/service_name/*
}}}
 * Reset the replication service schema
{{{
TRUNCATE TABLE tungsten_service_name.trep_commit_seqno;
TRUNCATE TABLE tungsten_service_name.heartbeat;
}}}
 * Resume replication
{{{
$TUNGSTEN_BIN/trepctl -service service_name online
}}}

=== Upgrading from Tungsten Replicator 2.0.4 to 2.0.5 ===

Tungsten Replicator is released quite frequently. We add planned features and fix bugs continuously. Therefore, getting [http://s3.amazonaws.com/files.continuent.com/builds/nightly/tungsten-2.0-snapshots/index.html the latest release] is very important.

If you have installed Tungsten Replicator 2.0.4 or later, and you want to upgrade to the latest version, here's what to do.

After you [http://code.google.com/p/tungsten-replicator/w/edit.do#Get_the_replicator get the replicator], run these commands for each host:

{{{
ssh host_name $TUNGSTEN_HOME/tungsten/tungsten-replicator/bin/replicator stop
./tools/update --host=host_name \
   --user=$USER \
   --release-directory=$TUNGSTEN_HOME
 
$TUNGSTEN_HOME/tungsten/tungsten-replicator/bin/trepctl -host host_name services
}}}

For example, if you have installed a regular master slave cluster using [http://code.google.com/p/tungsten-replicator/w/edit.do#Install_a_master_/_slave_cluster this recipe], the release directory will be $HOME/replication.

If the replicator is offline after the update command (that depends on your settings), you can simply put it online using trepctl.


*Notes:* 
  * Upgrading from previous version of Tungsten Replicator requires a manual re-installation, because of the new installer format.
Upgrading to the next version of Tungsten should be handled in the same way described in this section.
  * The host used in the above commands must be the same used when the server was defined. If a host can be addressed by two names (e.g _m1.mynetwork.com_ and _m1_) the same name that was used during installation must also be used for the upgrade.

=== Increasing the JVM memory size ===

The {{{--java-mem-size}}} option sets the amount of memory allocated to the JVM.  You can update the allocation on an existing replicator using the {{{tools/update}}} script.

{{{
$TUNGSTEN_HOME/tungsten/tools/update -a --java-mem-size=1024
$TUNGSTEN_HOME/tungsten/tungsten-replicator/bin/replicator restart
$TUNGSTEN_HOME/tungsten/tungsten-replicator/bin/trepctl services
}}}

=== Managing replicator log space ===

There are 3 kinds of logs used in Tungsten Replicator.
 * Master Relay Logs
 * Transaction History Logs
 * Service Logs

==== Master Relay Logs ===

The Master Relay Logs (MRL) are used when the master is extracting events from a MySQL server.  The MRL files are stored in the {{{$TUNGSTEN_HOME/relay/service_name}}} directory.  Use a symlink if you would like to store these files on a different disk.

The {{{replicator.extractor.dbms.relayLogRetention}}} value in {{{tungsten-replicator/conf/static-service_name.properties}}} defines how many MRL files are kept after the replicator service has extracted events from it.  You can configure this setting using the {{{--property}}} flag.

{{{
# New Installation
./tools/tungsten-installer ... --property=replicator.extractor.dbms.relayLogRetention=4

# Existing Installation
$TUNGSTEN_HOME/tools/configure-service -U --property=replicator.extractor.dbms.relayLogRetention=4 service_name
$TUNGSTEN_HOME/tungsten-replicator/bin/trepctl -service service_name stop
$TUNGSTEN_HOME/tungsten-replicator/bin/trepctl -service service_name start
$TUNGSTEN_HOME/tungsten-replicator/bin/trepctl -service service_name status
}}}

==== Transaction History Logs ====

The Transaction History Logs (THL) are used to store events after they are extracted, to transmit events between the master and slave and to store events prior to being applied.  The THL files are stored in the {{{$TUNGSTEN_HOME/thl/service_name}}} directory.  Use a symlink if you would like to store these files on a different disk.

The {{{replicator.store.thl.log_file_retention}}} value in {{{tungsten-replicator/conf/static-service_name.properties}}} defines how long THL files are kept.  You can configure this setting using the {{{--property}}} flag.

{{{
# New Installation
./tools/tungsten-installer ... --property=replicator.store.thl.log_file_retention=3d

# Existing Installation
$TUNGSTEN_HOME/tools/configure-service -U --property=replicator.store.thl.log_file_retention=3d service_name
$TUNGSTEN_HOME/tungsten-replicator/bin/trepctl -service service_name stop
$TUNGSTEN_HOME/tungsten-replicator/bin/trepctl -service service_name start
$TUNGSTEN_HOME/tungsten-replicator/bin/trepctl -service service_name status
}}}

==== Service Logs ====

The log files are stored in {{{tungsten-replicator/log}}}.  There are two service logs maintained by the replicator.

 * {{{user.log}}} - Partial service log that includes state changes and basic error messages
 * {{{trepsvc.log}}} - Complete service log including stack traces

The settings for these log files are located in {{{tungsten-replicator/conf/log4j.properties}}}.  You can modify the {{{log4j.appender.file.MaxFileSize}}} and {{{log4j.appender.file.MaxBackupIndex}}} values for each log file to manage how much disk space is required to hold the log files.

Check out the [TungstenReplicatorCookbook#Modify_the_configuration_template_file_prior_to_configuration] recipe for an idea of how you can update the {{{log4j.properties}}} file as part of installation.

Short link to this page: [http://bit.ly/tr20_cookbook http://bit.ly/tr20_cookbook]

== Monitoring and Troubleshooting ==

=== Monitor JVM memory usage ===

It is possible to use JConsole to monitor the memory usage of the Tungsten Replicator process.  If you see that the allocated memory is filling up, you may increase it using the {{--java-mem-size}} argument.

JConsole requires that jmxremote is enabled in {{{tungsten-replicator/conf/wrapper.conf}}}.  It is enabled by default but make sure that {{{wrapper.java.additional.3=-Dcom.sun.management.jmxremote}}} is not commented out in the file.

You can get information on JConsole at [http://java.sun.com/developer/technicalArticles/J2SE/jconsole.html].